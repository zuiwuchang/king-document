var __v="\u003cstrong\u003e*.proto\u003c/strong\u003e\n\u003cpre class='prettyprint linenums'\u003esyntax = \"proto3\";\n\npackage basic;\n\n// 以 service 標記定義一個 服務\nservice TestServer {\n\t//以 rpc 定義 方法\n\trpc Say(SayRequest) returns (SayReply) {}\n\n\t//以 rpc 定義 方法\n\trpc SayStream(stream SayRequest) returns (stream SayReply) {}\n}\n\n/***\t定義 proto3 數據 \t***/\nmessage SayRequest {\n\tstring Name = 1;\n\tstring Text = 2;\n}\nmessage SayReply{\n\tstring\tText = 1;\n}\n\u003c/pre\u003e\n\u003cstrong\u003eserver\u003c/strong\u003e\n\u003cpre class='prettyprint linenums'\u003epackage main\n\nimport (\n\t\"fmt\"\n\t\"golang.org/x/net/context\"\n\t\"google.golang.org/grpc\"\n\t\"google.golang.org/grpc/reflection\"\n\t\"io\"\n\t\"log\"\n\t\"net\"\n\tpb \"test/net/basic\"\n)\n\nconst (\n\tLAddr = \":1102\"\n)\n\nfunc main() {\n\t//創建 監聽 Listener\n\tl, e := net.Listen(\"tcp\", LAddr)\n\tif e != nil {\n\t\tlog.Fatalln(e)\n\t}\n\tlog.Println(\"work at\", LAddr)\n\n\t//創建 rpc 服務器\n\ts := grpc.NewServer()\n\n\t//註冊 服務\n\tpb.RegisterTestServerServer(s, \u0026amp;testServer{})\n\n\t//註冊 反射 到 服務 路由\n\treflection.Register(s)\n\n\t//讓 rpc 在 Listener 上 工作\n\tif e := s.Serve(l); e != nil {\n\t\tlog.Fatalln(e)\n\t}\n}\n\n//定義 服務器\ntype testServer struct {\n}\n\n//實現 服務器 接口\nfunc (s *testServer) Say(ctx context.Context, in *pb.SayRequest) (*pb.SayReply, error) {\n\t//邏輯 處理\n\tfmt.Printf(\"%v say : %v\\n\", in.Name, in.Text)\n\n\t//響應\n\treturn \u0026amp;pb.SayReply{\n\t\t\tText: \"OK\",\n\t\t},\n\t\tnil\n}\nfunc (s *testServer) SayStream(stream pb.TestServer_SayStreamServer) (e error) {\n\tvar req pb.SayRequest\n\trepl := \u0026amp;pb.SayReply{\n\t\tText: \"ok\",\n\t}\n\tfor {\n\t\t//獲取 請求\n\t\te = stream.RecvMsg(\u0026amp;req)\n\t\tif e != nil {\n\t\t\tif e != io.EOF {\n\t\t\t\tlog.Println(e)\n\t\t\t}\n\t\t\treturn\n\t\t}\n\t\tfmt.Printf(\"%v say : %v\\n\", req.Name, req.Text)\n\n\t\t//響應\n\t\te = stream.Send(repl)\n\t\tif e != nil {\n\t\t\tlog.Println(e)\n\t\t\treturn\n\t\t}\n\t}\n\treturn\n}\n\u003c/pre\u003e\n\u003cstrong\u003eclient\u003c/strong\u003e\n\u003cpre class='prettyprint linenums'\u003epackage main\n\nimport (\n\t\"fmt\"\n\t\"golang.org/x/net/context\"\n\t\"google.golang.org/grpc\"\n\t\"log\"\n\t\"strings\"\n\tpb \"test/net/basic\"\n\t\"time\"\n)\n\nconst (\n\tAddr = \"127.0.0.1:1102\"\n)\n\nfunc main() {\n\t//連接 服務器\n\tconn, e := grpc.Dial(Addr, grpc.WithInsecure())\n\tif e != nil {\n\t\tlog.Fatalln(e)\n\t}\n\tdefer conn.Close()\n\t//創建 rpc 服務 客戶端\n\tc := pb.NewTestServerClient(conn)\n\tvar cmd, name string\n\tfor {\n\t\tfmt.Print(\"#\u0026gt;\")\n\t\tfmt.Scan(\u0026amp;cmd)\n\t\tif cmd == \"e\" {\n\t\t\tbreak\n\t\t} else if strings.HasPrefix(cmd, \"name=\") {\n\t\t\tcmd = cmd[len(\"name=\"):]\n\t\t\tname = cmd\n\t\t} else if strings.HasPrefix(cmd, \"say=\") {\n\t\t\tcmd = cmd[len(\"say=\"):]\n\n\t\t\tif repl, e := c.Say(\n\t\t\t\tcontext.Background(),\n\t\t\t\t\u0026amp;pb.SayRequest{\n\t\t\t\t\tName: name,\n\t\t\t\t\tText: cmd,\n\t\t\t\t},\n\t\t\t); e == nil {\n\t\t\t\tfmt.Println(repl)\n\t\t\t} else {\n\t\t\t\tlog.Println(e)\n\t\t\t}\n\t\t} else if strings.HasPrefix(cmd, \"say2=\") {\n\t\t\tcmd = cmd[len(\"say2=\"):]\n\t\t\tstream, e := c.SayStream(context.Background())\n\t\t\tif e != nil {\n\t\t\t\tlog.Println(e)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tvar repl pb.SayReply\n\t\t\tfor i := 0; i \u0026lt; 3; i++ {\n\t\t\t\t//發送\n\t\t\t\tstream.Send(\u0026amp;pb.SayRequest{\n\t\t\t\t\tName: name,\n\t\t\t\t\tText: cmd,\n\t\t\t\t})\n\n\t\t\t\te = stream.RecvMsg(\u0026amp;repl)\n\t\t\t\tif e != nil {\n\t\t\t\t\tlog.Println(e)\n\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t\tfmt.Println(repl)\n\t\t\t\ttime.Sleep(time.Second)\n\t\t\t}\n\t\t\t//通知 不會在有 請求到達\n\t\t\tstream.CloseSend()\n\t\t}\n\t}\n}\n\u003c/pre\u003e"