var __v="\n\u003cpre class='prettyprint linenums'\u003eEXCEPTIOIN loadDriver(const std::wstring\u0026amp; driver_name,const std::wstring\u0026amp; driver_path) \n{\n\tSC_HANDLE  sc_handle_scm=NULL,sc_handle_service=NULL;\n\t//打开服务管理器  \n\ttry\n\t\t{\n\t\tsc_handle_scm=OpenSCManager(NULL,//主机名 NULL 代表本机\n\t\t\tNULL,\t//scm数据库名 NULL使用默认\n\t\t\tSC_MANAGER_ALL_ACCESS);//权限 此为全部 至少要SC_MANAGER_CREATE_SERVICE （既创建服务的权限）\n\t\tif(!sc_handle_scm)\n\t\t{\n\t\t\tstd::exception e(\"打开scm服务管理器失败\",GetLastError());\n\t\t\tthrow e;\n\t\t}\n\n\t\t//创建服务\n\t\tsc_handle_service=CreateService(sc_handle_scm,//scm管理器句柄\n\t\t\tdriver_name.c_str(),\t//驱动程序在注册表中的名字 既服务名\n\t\t\tdriver_name.c_str(),\t//注册表驱动程序的 DisplayName （驱动路径）\n\t\t\tSC_MANAGER_ALL_ACCESS,\t//权限 此为全部权限\n\t\t\tSERVICE_KERNEL_DRIVER,  //服务类型 此为驱动\n\t\t\tSERVICE_DEMAND_START,\t//注册表的start值\n\t\t\tSERVICE_ERROR_IGNORE,\t//注册表的ErrorControl值\n\t\t\tdriver_path.c_str(),\t//注册表的ImagePath值 既然驱动的路径\n\t\t\tNULL,\t//需要开启服务的用户组\n\t\t\tNULL,\t//输出验证标签\n\t\t\tNULL,\t//所依赖服务的名称\n\t\t\tNULL,\t//用户帐户名\n\t\t\tNULL\t//用户口令\n\t\t\t);\n\n\t\tif(!sc_handle_service)\n\t\t{\n\t\t\tDWORD error_code=GetLastError();\n\t\t\tif(ERROR_DUPLICATE_SERVICE_NAME==error_code)\n\t\t\t{\n\t\t\t\t//打开服务句柄\n\t\t\t\tsc_handle_service=OpenService(sc_handle_scm,driver_name.c_str(),SC_MANAGER_ALL_ACCESS );\n\t\t\t\tif(!sc_handle_service)\n\t\t\t\t{\n\t\t\t\t\tdark::debug::wexception e(L\"打开服务句柄失败\",GetLastError());\n\t\t\t\t\tthrow e;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tdark::debug::wexception e(L\"创建服务失败\",GetLastError());\n\t\t\t\tthrow e;\n\t\t\t}\n\t\t}\n\n\t\t//运行服务\n\t\tif(!StartService(sc_handle_service,NULL,NULL))\n\t\t{\n\t\t\tdark::debug::wexception e(L\"打开服务失败\",GetLastError());\n\t\t\tthrow e;\n\t\t}\n\n\t\tdark::debug::wexception e(false);\n\t\tthrow e;\n\t}\n\tcatch(const dark::debug::wexception\u0026amp; e)\n\t{\n\t\tif(sc_handle_scm)\n\t\t{\n\t\t\tCloseServiceHandle(sc_handle_scm);\n\t\t}\n\t\tif(sc_handle_service)\n\t\t{\n\t\t\tCloseServiceHandle(sc_handle_service);\n\t\t}\n\t\n\t\tif(e.isException())\n\t\t{\n\t\t\tthrow e;\n\t\t}\n\t}\n\n}\u003c/pre\u003e"