var __v="\n\u003cpre class='prettyprint linenums'\u003e#ifndef _DARK_DIRECT_WIC_\n#define _DARK_DIRECT_WIC_\n\n#include\u0026lt;boost\\smart_ptr.hpp\u0026gt;\n#include \"com.hpp\"\n\n//#include\u0026lt;wincodec.h\u0026gt;\n//#pragma comment(lib,\"Windowscodecs.lib\")\n\nnamespace dark\n{\n\tnamespace direct\n\t{\n\t\ttypedef boost::shared_ptr\u0026lt;IWICFormatConverter\u0026gt; wic_converter_bitmap_ptr_t;\n\t\tclass wic_factory\n\t\t{\n\t\tprivate:\n\t\t\tIWICImagingFactory *wic_factory_ptr_;\n\t\tpublic:\n\t\t\twic_factory()\n\t\t\t{\n\t\t\t\twic_factory_ptr_\t=\tNULL;\n\t\t\t}\n\t\t\tvirtual inline HRESULT initialize()\n\t\t\t{\n\t\t\t\treturn CoCreateInstance(\n\t\t\t\t\tCLSID_WICImagingFactory,\n\t\t\t\t\tNULL,\n\t\t\t\t\tCLSCTX_INPROC_SERVER,\n\t\t\t\t\tIID_IWICImagingFactory,\n\t\t\t\t\t(LPVOID*)\u0026amp;wic_factory_ptr_\n\t\t\t\t\t);\n\t\t\t}\n\t\t\tvirtual void release()\n\t\t\t{\n\t\t\t\tDARK_SAFE_RELEASE_COM(wic_factory_ptr_);\n\t\t\t}\n\n\t\t\twic_converter_bitmap_ptr_t load_bitmap(const std::wstring\u0026amp; path)\n\t\t\t{\n\t\t\t\twic_converter_bitmap_ptr_t rs;\n\t\t\t\t//加載圖片\n\t\t\t\tIWICBitmapDecoder *wic_decoder_ptr = NULL;\n\t\t\t\tif(S_OK\t!=\twic_factory_ptr_-\u0026gt;CreateDecoderFromFilename(path.c_str()\n\t\t\t\t\t\t\t\t\t,NULL\n\t\t\t\t\t\t\t\t\t,GENERIC_READ\n\t\t\t\t\t\t\t\t\t,WICDecodeMetadataCacheOnDemand\n\t\t\t\t\t\t\t\t\t,\u0026amp;wic_decoder_ptr\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t{\n\t\t\t\t\treturn rs;\n\t\t\t\t}\n\t\t\t\tboost::shared_ptr\u0026lt;IWICBitmapDecoder\u0026gt; wic_decoder_shared_ptr(wic_decoder_ptr, dark::com_tools::delete_com\u0026lt;IWICBitmapDecoder\u0026gt;);\n\n\t\t\t\t//獲取幀數\n\t\t\t\tUINT frame_count = 0;\n\t\t\t\tif(S_OK\t!=\twic_decoder_ptr-\u0026gt;GetFrameCount(\u0026amp;frame_count)\n\t\t\t\t\t|| !frame_count\n\t\t\t\t\t)\n\t\t\t\t{\n\t\t\t\t\treturn rs;\n\t\t\t\t}\n\n\t\t\t\t//讀取圖像第1幀\n\t\t\t\tIWICBitmapFrameDecode* wic_frame_ptr\t=\tNULL;\n\t\t\t\tif(S_OK\t!=\twic_decoder_ptr-\u0026gt;GetFrame(0,\u0026amp;wic_frame_ptr))\n\t\t\t\t{\n\t\t\t\t\treturn rs;\n\t\t\t\t}\n\t\t\t\tboost::shared_ptr\u0026lt;IWICBitmapFrameDecode\u0026gt; wic_frame_shared_ptr(wic_frame_ptr,dark::com_tools::delete_com\u0026lt;IWICBitmapFrameDecode\u0026gt;);\n\n\t\t\t\t//轉換為D2D支持的格式 \n\t\t\t\tIWICFormatConverter* wic_converter_ptr\t=\tNULL;\n\t\t\t\tif(S_OK != wic_factory_ptr_-\u0026gt;CreateFormatConverter(\u0026amp;wic_converter_ptr))\n\t\t\t\t{\n\t\t\t\t\treturn rs;\n\t\t\t\t}\n\t\t\t\twic_converter_bitmap_ptr_t wic_converter_shared_ptr(wic_converter_ptr,dark::com_tools::delete_com\u0026lt;IWICFormatConverter\u0026gt;);\n\t\t\t\tif(S_OK\t==\twic_converter_shared_ptr-\u0026gt;Initialize(wic_frame_ptr\n\t\t\t\t\t\t\t,GUID_WICPixelFormat32bppPBGRA\n\t\t\t\t\t\t\t,WICBitmapDitherTypeNone      \t\t\n\t\t\t\t\t\t\t,NULL         \n\t\t\t\t\t\t\t,0.f\n\t\t\t\t\t\t\t,WICBitmapPaletteTypeMedianCut\n\t\t\t\t\t\t)\n\t\t\t\t\t\t)\n\t\t\t\t{\n\t\t\t\t\trs\t=\twic_converter_shared_ptr;\n\t\t\t\t}\n\t\t\t\treturn rs;\n\t\t\t}\n\n\t\t};\n\t};\n};\n#endif\t//_DARK_DIRECT_WIC_\u003c/pre\u003e"