var __v="\n\u003cpre class='prettyprint linenums'\u003e// test_sc.cpp : 定义控制台应用程序的入口点。\n//\n\n#include \"stdafx.h\"\n\nvoid install();\nvoid uninstall();\n\nint _tmain(int argc, _TCHAR* argv[])\n{\n\tputs(\"***\t開始安裝測試\t***\");\n\tinstall();\n\tputs(\"***\t結束安裝測試\t***\");\n\n\tputs(\"***\t開始卸載測試\t***\");\n\tuninstall();\n\tputs(\"***\t結束卸載測試\t***\");\n\t\n\tsystem(\"pause\");\n\treturn 0;\n}\n\nvoid install()\n{\n\t//連接 scm 管理器\n\tSC_HANDLE hScm = OpenSCManager(NULL,NULL,SC_MANAGER_CREATE_SERVICE);\n\tif(hScm)\n\t{\n\t\t//創建一個 服務\n\t\tSC_HANDLE hServer = CreateService(hScm,\n\t\t\tL\"ks-test\",\n\t\t\tL\"ks-test 服務 api 測試\",\n\t\t\tSERVICE_ALL_ACCESS,\n\t\t\tSERVICE_WIN32_OWN_PROCESS,\t//exe中只提供單個服務\n\t\t\tSERVICE_DEMAND_START,\t\t//手動啓動\n\t\t\tSERVICE_ERROR_NORMAL,\n\t\t\tL\"c:/a.exe\",\n\t\t\tNULL,\n\t\t\tNULL,\n\t\t\tNULL,\n\t\t\tNULL,\n\t\t\tNULL);\n\t\tif(hServer)\n\t\t{\n\n\t\t\t//修改服務描述\n\t\t\tSERVICE_DESCRIPTION description;\n\t\t\tdescription.lpDescription = L\"服務 api 測試\";\n\t\t\tif(!ChangeServiceConfig2(hServer,SERVICE_CONFIG_DESCRIPTION,\u0026amp;description))\n\t\t\t{\n\t\t\t\tputs(\"設置服務描述 失敗\");\n\t\t\t}\n\n\t\t\t//查詢服務狀態\n\t\t\tSERVICE_STATUS status;\n\t\t\tif(QueryServiceStatus(hServer,\u0026amp;status))\n\t\t\t{\n\t\t\t\tswitch(status.dwCurrentState)\n\t\t\t\t{\n\t\t\t\tcase SERVICE_RUNNING:\n\t\t\t\t\tputs(\"運行中\");\n\n\t\t\t\t\t//通知服務停止\n\t\t\t\t\tControlService(hServer,SERVICE_CONTROL_STOP,NULL);\n\t\t\t\t\tbreak;\n\t\t\t\tcase  SERVICE_STOPPED:\n\t\t\t\t\tputs(\"服務已停止\");\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tputs(\"獲取服務 狀態失敗\");\n\t\t\t}\n\t\t\t//關閉 服務句柄\n\t\t\tCloseServiceHandle(hServer);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tif(ERROR_SERVICE_EXISTS == GetLastError())\n\t\t\t{\n\t\t\t\tputs(\"服務已存在\");\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tputs(\"創建服務失敗\");\n\t\t\t}\n\t\t}\n\t\t//關閉 scm\n\t\tCloseServiceHandle(hScm);\n\t}\n\telse\n\t{\n\t\tputs(\"打開scm 失敗\");\n\t}\n}\nvoid uninstall()\n{\n\t//連接 scm 管理器\n\tSC_HANDLE hScm = OpenSCManager(NULL,NULL,SC_MANAGER_CREATE_SERVICE);\n\tif(hScm)\n\t{\n\t\t//打開 服務\n\t\tSC_HANDLE hServer = OpenService(hScm,L\"ks-test\",SERVICE_ALL_ACCESS);\n\t\tif(hServer)\n\t\t{\n\t\t\tif(DeleteService(hServer))\n\t\t\t{\n\t\t\t\tputs(\"刪除服務成功\");\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tputs(\"刪除服務失敗\");\n\t\t\t}\n\t\t\t//關閉 服務句柄\n\t\t\tCloseServiceHandle(hServer);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tputs(\"打開服務 失敗\");\n\t\t}\n\t}\n\telse\n\t{\n\t\tputs(\"打開scm 失敗\");\n\t}\n}\u003c/pre\u003e"