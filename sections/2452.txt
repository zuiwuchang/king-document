var __v="\n\u003cpre class='prettyprint linenums'\u003eusing System.Net.Sockets;\n\nnamespace Server\n{\n    class Program\n    {\n        static void Main(string[] args)\n        {\n            //創建一個 socket\n            Socket l = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);\n\n            try \n\t        {\n                //綁定 socket\n                l.Bind(new System.Net.IPEndPoint(System.Net.IPAddress.Any, 1102));\n\t\t        \n                //監聽 socket\n                l.Listen(50);\n\n                //投遞新的 accept\n                for (int i = 0; i \u0026lt; Environment.ProcessorCount; i++)\n                {\n                    PostAccept(l);   \n                }\n            }\n\t        catch (SocketException e)\n\t        {\n                Console.WriteLine(e.Message);\n\t        }\n            \n            Console.WriteLine(\"press any key to exit\");\n            Console.ReadLine();\n        }\n        static void PostAccept(Socket l)\n        {\n            \n            //異步 accept\n            l.BeginAccept(asyncResult =\u0026gt;\n            {\n                //投遞新的 accept\n                PostAccept(l);\n\n                //返回 客戶端\n                Socket c = l.EndAccept(asyncResult);\n                Console.WriteLine(\"{0} in\",c.RemoteEndPoint);\n\n                //投遞新的 write\n                PostWrite(c, \"this is cerberus's server\");\n\n                //投遞新的 recv\n                PostRecv(c);\n            }, null);\n        }\n        static void PostWrite(Socket c, string str)\n        {\n            byte[] buf = System.Text.Encoding.UTF8.GetBytes(str);\n            try\n            {\n                c.BeginSend(buf, 0, buf.Length, SocketFlags.None, asyncResult =\u0026gt;\n                {\n                    try\n                    {\n                        c.EndSend(asyncResult);\n                    }\n                    catch (SocketException e)\n                    {\n                        Console.WriteLine(e.Message);\n                        Console.WriteLine(\"{0} out\", c.RemoteEndPoint);\n                    }\n\n                }, null);\n            }\n            catch (SocketException e)\n            {\n                Console.WriteLine(e.Message);\n                Console.WriteLine(\"{0} out\", c.RemoteEndPoint);\n            }\n \n        }\n        static void PostRecv(Socket c)\n        {\n            byte[] buf = new byte[1024];\n            try\n            {\n                c.BeginReceive(buf, 0, buf.Length, SocketFlags.None,\n                asyncResult =\u0026gt;\n                {\n                    //返回數據\n                    try\n                    {\n                        int n = c.EndReceive(asyncResult);\n                        if (n \u0026lt; 1)\n                        {\n                            Console.WriteLine(\"{0} out\", c.RemoteEndPoint);\n                            return;\n                        }\n                        string str = System.Text.Encoding.UTF8.GetString(buf, 0, n);\n                        Console.WriteLine(\"recv ({0}) : {1}\", c.RemoteEndPoint, str);\n\n                        //投遞新的 recv\n                        PostRecv(c);\n                    }\n                    catch (SocketException e)\n                    {\n                        Console.WriteLine(e.Message);\n                        Console.WriteLine(\"{0} out\", c.RemoteEndPoint);\n                    }\n                }, null);\n            }\n            catch (SocketException e)\n            {\n                Console.WriteLine(e.Message);\n                Console.WriteLine(\"{0} out\", c.RemoteEndPoint);\n            }\n \n        }\n    }\n}\u003c/pre\u003e"